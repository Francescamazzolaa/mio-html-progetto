<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyFlow - Master Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #6366f1;
            --primary-light: #e0e7ff;
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --danger: #ef4444;
            --success: #10b981;
            --sidebar-w: 260px;
            --sidebar-w-collapsed: 80px;
            --radius: 16px;
            --transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .dark-mode {
            --primary: #818cf8;
            --primary-light: #1e1b4b;
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border: #334155;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg-body); color: var(--text-main); height: 100vh; overflow: hidden; }

        /* LAYOUT */
        .app { display: flex; height: 100%; width: 100%; }
        
        /* SIDEBAR */
        .sidebar {
            width: var(--sidebar-w); background: var(--bg-card); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; padding: 20px; transition: width var(--transition); 
            z-index: 20; overflow: hidden; white-space: nowrap;
        }
        .sidebar.collapsed { width: var(--sidebar-w-collapsed); }
        .sidebar.collapsed .logo-text, .sidebar.collapsed .nav-text { opacity: 0; pointer-events: none; display: none; }
        .sidebar.collapsed .nav-item { justify-content: center; padding: 12px 0; }
        .sidebar.collapsed .logo { justify-content: center; }

        .logo { font-size: 20px; font-weight: 800; color: var(--primary); margin-bottom: 40px; display: flex; align-items: center; gap: 12px; height: 30px; }
        
        .nav-item {
            padding: 12px 16px; margin-bottom: 8px; border-radius: var(--radius); cursor: pointer;
            color: var(--text-muted); font-weight: 500; display: flex; align-items: center; gap: 15px; transition: 0.2s;
        }
        .nav-item:hover, .nav-item.active { background: var(--primary-light); color: var(--primary); }
        .nav-item i { font-size: 20px; min-width: 24px; text-align: center; }

        /* MAIN CONTENT */
        .main { flex: 1; display: flex; flex-direction: column; position: relative; min-width: 0; }
        .header {
            height: 80px; background: var(--bg-card); border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between; padding: 0 30px;
        }
        .content { flex: 1; overflow-y: auto; padding: 30px; scroll-behavior: smooth; }

        /* COMMON UI */
        .btn { padding: 12px 24px; border-radius: var(--radius); border: none; font-weight: 600; cursor: pointer; gap: 8px; display: inline-flex; align-items: center; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3); }
        .btn-icon { width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; background: transparent; border: 1px solid var(--border); color: var(--text-main); cursor: pointer; }
        .btn-icon:hover { background: var(--bg-body); border-color: var(--primary); }
        
        .btn-trash { color: var(--text-muted); background: transparent; border: none; cursor: pointer; transition: 0.2s; padding: 8px; border-radius: 8px; }
        .btn-trash:hover { color: var(--danger); background: rgba(239, 68, 68, 0.1); }

        .card { background: var(--bg-card); border-radius: var(--radius); padding: 24px; border: 1px solid var(--border); box-shadow: 0 2px 8px rgba(0,0,0,0.04); margin-bottom: 24px; position: relative; }
        
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; }
        .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px; }

        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-size: 13px; font-weight: 600; color: var(--text-muted); }
        .form-control { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid var(--border); background: var(--bg-body); color: var(--text-main); outline: none; }

        /* CALENDAR */
        .cal-toolbar { display: flex; gap: 5px; background: var(--bg-body); padding: 5px; border-radius: 12px; }
        .cal-btn { border: none; background: transparent; padding: 8px 16px; border-radius: 8px; color: var(--text-muted); cursor: pointer; font-weight: 600; font-size: 13px; }
        .cal-btn.active { background: var(--bg-card); color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .cal-grid { display: grid; gap: 10px; }
        .cal-cell { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 10px; min-height: 100px; font-size: 12px; transition: 0.2s; }
        .event-chip { font-size: 11px; padding: 4px 8px; border-radius: 6px; margin-top: 4px; border-left: 3px solid; background: var(--bg-body); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* WRAPPED & STATS */
        .wrapped-banner { background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 40px; border-radius: 20px; margin-bottom: 30px; position: relative; }
        .wrapped-stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 20px; }
        .wrapped-box { background: rgba(255,255,255,0.2); padding: 15px; border-radius: 12px; text-align: center; }
        .wrapped-val { font-size: 24px; font-weight: 800; }
        
        .stat-card { text-align: center; padding: 20px; border-radius: 16px; background: var(--bg-card); border: 1px solid var(--border); }
        .stat-val { font-size: 32px; font-weight: 800; color: var(--primary); margin-bottom: 5px; }
        .stat-lbl { font-size: 13px; color: var(--text-muted); font-weight: 600; text-transform: uppercase; }

        /* MODALS & CLOSE BUTTON */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(4px); }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--bg-card); width: 90%; max-width: 500px; padding: 30px; border-radius: 24px; box-shadow: 0 20px 40px -10px rgba(0,0,0,0.2); animation: slideUp 0.3s; position: relative; }
        
        /* THE X BUTTON */
        .close-modal-x {
            position: absolute; top: 15px; right: 15px;
            width: 32px; height: 32px; border-radius: 50%;
            background: var(--bg-body); border: none; color: var(--text-muted);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.2s;
        }
        .close-modal-x:hover { background: #fee2e2; color: #ef4444; }

        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .view { display: none; animation: fadeIn 0.4s; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        @media (max-width: 768px) {
            .sidebar { position: absolute; height: 100%; left: -100%; }
            .sidebar.mobile-open { left: 0; width: 260px !important; }
            .grid-3, .grid-2, .grid-4 { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div class="app">
    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
        <div class="logo">
            <i class="fas fa-brain"></i> <span class="logo-text">StudyFlow</span>
        </div>
        <nav>
            <div class="nav-item active" onclick="Router.go('brief')"><i class="fas fa-sun"></i> <span class="nav-text">Morning Brief</span></div>
            <div class="nav-item" onclick="Router.go('subjects')"><i class="fas fa-book"></i> <span class="nav-text">Materie</span></div>
            <div class="nav-item" onclick="Router.go('timer')"><i class="fas fa-clock"></i> <span class="nav-text">Timer</span></div>
            <div class="nav-item" onclick="Router.go('calendar')"><i class="fas fa-calendar-alt"></i> <span class="nav-text">Calendario</span></div>
            <div class="nav-item" onclick="Router.go('wrapped')"><i class="fas fa-award"></i> <span class="nav-text">Session Wrapped</span></div>
            <div class="nav-item" onclick="Router.go('analytics')"><i class="fas fa-chart-pie"></i> <span class="nav-text">Analytics</span></div>
            <div class="nav-item" onclick="Router.go('settings')"><i class="fas fa-cog"></i> <span class="nav-text">Impostazioni</span></div>
        </nav>
    </aside>

    <!-- MAIN -->
    <main class="main">
        <header class="header">
            <div style="display: flex; align-items: center; gap: 15px;">
                <button class="btn-icon" onclick="App.toggleSidebar()"><i class="fas fa-bars"></i></button>
                <button class="btn-icon" id="btn-back" onclick="Router.back()" style="display: none;"><i class="fas fa-arrow-left"></i></button>
                <h2 id="page-title" style="font-size: 18px; font-weight: 700;">Morning Brief</h2>
            </div>
            <button class="btn-icon" onclick="App.toggleTheme()"><i class="fas fa-moon"></i></button>
        </header>

        <div class="content">
            
            <!-- VISTA: BRIEF -->
            <div id="view-brief" class="view active">
                <div class="card" style="background: linear-gradient(135deg, var(--primary), #4338ca); color: white; border:none; padding: 40px;">
                    <h1 id="greeting-text" style="font-size: 32px; margin-bottom: 10px;">Buongiorno</h1>
                    <p id="current-date" style="opacity: 0.9; font-size: 16px;">--</p>
                </div>
                <h3 style="margin: 30px 0 15px;">Il tuo Piano per Oggi</h3>
                <div class="grid-2">
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h4 style="margin: 0;">Da Studiare/Ripassare</h4>
                            <span class="event-chip" style="background: var(--bg-body); border: none;" id="brief-count">0 AttivitÃ </span>
                        </div>
                        <div id="brief-list"></div>
                    </div>
                    <div class="card">
                        <h4 style="margin-bottom: 20px;">Nuovi Argomenti</h4>
                        <div id="new-topics-list" style="margin-top: 15px;"></div>
                    </div>
                </div>
            </div>

            <!-- VISTA: MATERIE -->
            <div id="view-subjects" class="view">
                <div style="display: flex; justify-content: flex-end; margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="Modal.open('modal-subject')"><i class="fas fa-plus"></i> Nuova Materia</button>
                </div>
                <div id="subjects-grid" class="grid-3"></div>
            </div>

            <!-- VISTA: TIMER -->
            <div id="view-timer" class="view">
                <div class="card" style="text-align: center; padding: 60px 20px;">
                    <h3 style="margin-bottom: 30px; color: var(--text-muted);">Focus Session</h3>
                    <div style="font-size: 90px; font-weight: 800; font-family: monospace; margin-bottom: 40px; color: var(--text-main);" id="timer-display">00:00:00</div>
                    <div id="timer-select-ui" style="max-width: 400px; margin: 0 auto 40px;">
                        <div class="form-group">
                            <label class="form-label">Materia</label>
                            <select id="timer-subject" class="form-control" onchange="Timer.loadTopics(this.value)"><option value="">Seleziona...</option></select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Argomento</label>
                            <select id="timer-topic" class="form-control"><option value="">Prima la materia</option></select>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: center; gap: 15px;">
                        <button class="btn btn-primary" id="btn-start" onclick="Timer.start()" style="padding: 15px 40px; font-size: 18px;"><i class="fas fa-play"></i> START</button>
                        <button class="btn btn-primary" id="btn-stop" onclick="Timer.stop()" style="background: #ef4444; display: none; padding: 15px 40px; font-size: 18px;"><i class="fas fa-stop"></i> STOP</button>
                    </div>
                </div>
            </div>

            <!-- VISTA: CALENDARIO -->
            <div id="view-calendar" class="view">
                <div class="card">
                    <div style="display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 15px;">
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <button class="btn-icon" onclick="Calendar.nav(-1)"><i class="fas fa-chevron-left"></i></button>
                            <h3 id="cal-title" style="min-width: 160px; text-align: center; font-size: 16px;">Mese</h3>
                            <button class="btn-icon" onclick="Calendar.nav(1)"><i class="fas fa-chevron-right"></i></button>
                        </div>
                        <div class="cal-toolbar">
                            <button class="cal-btn active" onclick="Calendar.setView('month', this)">Mese</button>
                            <button class="cal-btn" onclick="Calendar.setView('week', this)">Settimana</button>
                            <button class="cal-btn" onclick="Calendar.setView('3day', this)">3 Giorni</button>
                            <button class="cal-btn" onclick="Calendar.setView('day', this)">Giorno</button>
                        </div>
                    </div>
                    <div id="cal-container"></div>
                </div>
            </div>

            <!-- VISTA: WRAPPED SESSIONE -->
            <div id="view-wrapped" class="view">
                <div id="wrapped-empty" class="card" style="text-align:center; padding: 60px;">
                    <i class="fas fa-university" style="font-size: 48px; color: var(--primary); margin-bottom: 20px;"></i>
                    <h2>Inizia una Nuova Sessione</h2>
                    <p class="text-muted" style="max-width: 400px; margin: 10px auto 30px;">Definisci i confini della tua sessione d'esame.</p>
                    <button class="btn btn-primary" onclick="Modal.open('modal-session')">Crea Sessione</button>
                </div>
                <div id="wrapped-active" class="hidden">
                    <div class="card" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; text-align:center; padding: 40px;">
                        <span class="event-chip" style="background: rgba(255,255,255,0.2); color:white; border:none; margin-bottom:10px;">SESSIONE IN CORSO</span>
                        <h1 id="active-session-name" style="margin-bottom: 10px;">Sessione</h1>
                        <p id="active-session-dates" style="opacity: 0.9;">--</p>
                        <div style="margin-top: 30px;">
                            <button class="btn" style="background: white; color: var(--primary);" onclick="SessionManager.close()">Chiudi e Genera Wrapped</button>
                        </div>
                    </div>
                </div>
                <h3 style="margin-top: 40px; margin-bottom: 20px;">Archivio Storico</h3>
                <div id="wrapped-history" class="grid-2"></div>
            </div>

            <!-- VISTA: REPORT WRAPPED -->
            <div id="view-wrapped-report" class="view">
                <div class="wrapped-banner">
                    <button class="close-modal-x" style="background:rgba(255,255,255,0.3); color:white;" onclick="Router.back()"><i class="fas fa-times"></i></button>
                    <h1 id="report-title">Sessione Wrapped</h1>
                    <p id="report-dates">Riepilogo finale</p>
                    <div class="wrapped-stat-grid">
                        <div class="wrapped-box"><div class="wrapped-val" id="rep-hours">0</div><div class="wrapped-lbl">Ore Totali</div></div>
                        <div class="wrapped-box"><div class="wrapped-val" id="rep-avg">0</div><div class="wrapped-lbl">Media/Giorno</div></div>
                        <div class="wrapped-box"><div class="wrapped-val" id="rep-sessions">0</div><div class="wrapped-lbl">Sessioni</div></div>
                    </div>
                </div>
                <div class="grid-2">
                    <div class="card"><h4>Top Argomenti</h4><div id="rep-top-topics" style="margin-top: 15px;"></div></div>
                    <div class="card"><h4>Distribuzione Materie</h4><div id="rep-subjects" style="margin-top: 15px;"></div></div>
                </div>
            </div>

            <!-- VISTA: ANALYTICS -->
            <div id="view-analytics" class="view">
                <h3 style="margin-bottom: 20px;">Statistiche</h3>
                <div class="grid-4" style="margin-bottom: 30px;">
                    <div class="stat-card"><div class="stat-val" id="stat-today-hours">0h</div><div class="stat-lbl">Oggi</div></div>
                    <div class="stat-card"><div class="stat-val" id="stat-week-hours">0h</div><div class="stat-lbl">7 Giorni</div></div>
                    <div class="stat-card"><div class="stat-val" id="stat-sessions">0</div><div class="stat-lbl">Totali</div></div>
                    <div class="stat-card"><div class="stat-val" id="stat-mastery">0%</div><div class="stat-lbl">Mastery</div></div>
                </div>
                <div class="card"><h4>Ore per Materia</h4><div id="analytics-chart" style="margin-top: 20px;"></div></div>
            </div>

            <!-- VISTA: SETTINGS -->
            <div id="view-settings" class="view">
                <div class="card"><h3>Gestione Dati</h3><button class="btn btn-primary" style="background: #ef4444; margin-top: 15px;" onclick="App.reset()">Reset Totale</button></div>
            </div>

        </div>
    </main>
</div>

<!-- MODALS WITH X BUTTON -->
<div class="modal-overlay" id="modal-subject">
    <div class="modal">
        <button class="close-modal-x" onclick="Modal.close('modal-subject')"><i class="fas fa-times"></i></button>
        <h3>Nuova Materia</h3>
        <div class="form-group"><label class="form-label">Nome</label><input type="text" id="sub-name" class="form-control"></div>
        <div class="form-group"><label class="form-label">Colore</label><input type="color" id="sub-color" class="form-control" style="height: 50px;" value="#6366f1"></div>
        <div class="form-group"><label class="form-label">Data Esame</label><input type="date" id="sub-exam" class="form-control"></div>
        <div style="text-align: right;"><button class="btn btn-primary" onclick="Logic.addSubject()">Salva</button></div>
    </div>
</div>

<div class="modal-overlay" id="modal-topic">
    <div class="modal">
        <button class="close-modal-x" onclick="Modal.close('modal-topic')"><i class="fas fa-times"></i></button>
        <h3>Nuovo Argomento</h3>
        <p class="text-muted" style="font-size: 13px; margin-bottom: 20px;">Inserisci il nome. Pianifica dopo lo studio.</p>
        <input type="hidden" id="topic-sub-id">
        <div class="form-group"><label class="form-label">Nome Argomento</label><input type="text" id="topic-name" class="form-control"></div>
        <div style="text-align: right;"><button class="btn btn-primary" onclick="Logic.addTopic()">Crea</button></div>
    </div>
</div>

<div class="modal-overlay" id="modal-rating">
    <div class="modal" style="text-align: center;">
        <button class="close-modal-x" onclick="Modal.close('modal-rating')"><i class="fas fa-times"></i></button>
        <h2 style="color: var(--primary);">Sessione Finita!</h2>
        <p class="text-muted">Hai studiato per <span id="rating-time">0</span> minuti.</p>
        <div style="margin: 30px 0;">
            <p style="font-weight: 600; margin-bottom: 15px;">DifficoltÃ  percepita?</p>
            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px;">
                <button class="btn btn-icon" style="width:100%; border-radius: 8px;" onclick="Timer.save(1)">1</button>
                <button class="btn btn-icon" style="width:100%; border-radius: 8px;" onclick="Timer.save(2)">2</button>
                <button class="btn btn-icon" style="width:100%; border-radius: 8px;" onclick="Timer.save(3)">3</button>
                <button class="btn btn-icon" style="width:100%; border-radius: 8px;" onclick="Timer.save(4)">4</button>
                <button class="btn btn-icon" style="width:100%; border-radius: 8px;" onclick="Timer.save(5)">5</button>
            </div>
            <p style="font-size: 11px; color: var(--text-muted); margin-top: 10px;">1=Difficile, 5=Facile</p>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal-session">
    <div class="modal">
        <button class="close-modal-x" onclick="Modal.close('modal-session')"><i class="fas fa-times"></i></button>
        <h3>Apri Nuova Sessione</h3>
        <div class="form-group"><label class="form-label">Nome Sessione</label><input type="text" id="sess-name" class="form-control" placeholder="Es. Sessione Invernale"></div>
        <div class="form-group"><label class="form-label">Inizio</label><input type="date" id="sess-start" class="form-control"></div>
        <div class="form-group"><label class="form-label">Fine</label><input type="date" id="sess-end" class="form-control"></div>
        <div style="text-align: right;"><button class="btn btn-primary" onclick="SessionManager.create()">Avvia</button></div>
    </div>
</div>

<script>
/** CORE LOGIC **/

const Scheduler = {
    calculate: (difficulty, startStr, examStr) => {
        const start = new Date(startStr);
        const exam = new Date(examStr);
        const diffTime = exam - start;
        const totalDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        if (totalDays <= 0) return [];

        const counts = {1:2, 2:3, 3:4, 4:5, 5:5};
        const N = counts[difficulty];
        let dates = [];
        
        if (totalDays <= N) {
            for(let i=1; i<=totalDays; i++) {
                let d = new Date(start); d.setDate(start.getDate() + i);
                if(d < exam) dates.push(d.toISOString().split('T')[0]);
            }
        } else {
            for(let i=1; i<=N; i++) {
                const factor = Math.pow(i / N, 2); 
                const daysToAdd = Math.max(1, Math.floor(totalDays * factor));
                let d = new Date(start); d.setDate(start.getDate() + daysToAdd);
                if (d >= exam) { d = new Date(exam); d.setDate(exam.getDate() - 1); }
                const dateStr = d.toISOString().split('T')[0];
                if (!dates.includes(dateStr) && dateStr > startStr) dates.push(dateStr);
            }
        }
        return dates;
    }
};

const DB = {
    data: JSON.parse(localStorage.getItem('sf_data')) || { subjects: [], topics: [], plan: [], sessions: [], uniSessions: [] },
    save: () => {
        localStorage.setItem('sf_data', JSON.stringify(DB.data));
        App.render();
    }
};

const SessionManager = {
    create: () => {
        const name = document.getElementById('sess-name').value;
        const start = document.getElementById('sess-start').value;
        const end = document.getElementById('sess-end').value;
        if(!name || !start || !end) return alert("Compila tutto");
        DB.data.uniSessions.forEach(s => { if(s.status === 'active') s.status = 'closed_auto'; });
        DB.data.uniSessions.push({ id: Date.now(), name, start, end, status: 'active', report: null });
        DB.save();
        Modal.close('modal-session');
        Router.go('wrapped');
    },
    close: () => {
        if(!confirm("Chiudere la sessione?")) return;
        const session = DB.data.uniSessions.find(s => s.status === 'active');
        if(!session) return;
        const relSessions = DB.data.sessions.filter(s => s.date >= session.start && s.date <= session.end);
        const totalMins = relSessions.reduce((acc, s) => acc + s.duration, 0);
        const totalHours = (totalMins / 60).toFixed(1);
        
        const topicStats = {};
        relSessions.forEach(s => {
            if(!topicStats[s.topicId]) topicStats[s.topicId] = 0;
            topicStats[s.topicId] += s.duration;
        });
        const topTopics = Object.keys(topicStats).sort((a,b) => topicStats[b] - topicStats[a]).slice(0, 3).map(tid => {
            const t = DB.data.topics.find(top => top.id == tid);
            return { name: t ? t.name : 'Unknown', mins: topicStats[tid] };
        });

        const subStats = {};
        relSessions.forEach(s => {
            const t = DB.data.topics.find(top => top.id == s.topicId);
            if(t) { if(!subStats[t.subId]) subStats[t.subId] = 0; subStats[t.subId] += s.duration; }
        });
        const subjectsData = Object.keys(subStats).map(sid => {
            const s = DB.data.subjects.find(sub => sub.id == sid);
            return { name: s ? s.name : 'Unknown', mins: subStats[sid], color: s ? s.color : '#ccc' };
        });

        const daysDiff = Math.max(1, Math.ceil((new Date() - new Date(session.start)) / (1000 * 60 * 60 * 24)));
        session.report = { totalHours, dailyAvg: (totalHours / daysDiff).toFixed(1), sessionsCount: relSessions.length, topTopics, subjectsData };
        session.status = 'closed';
        DB.save();
        SessionManager.showReport(session.id);
    },
    render: () => {
        const active = DB.data.uniSessions.find(s => s.status === 'active');
        const history = DB.data.uniSessions.filter(s => s.status !== 'active').reverse();
        
        const emptyDiv = document.getElementById('wrapped-empty');
        const activeDiv = document.getElementById('wrapped-active');
        
        if(active) {
            emptyDiv.style.display = 'none';
            activeDiv.style.display = 'block';
            document.getElementById('active-session-name').innerText = active.name;
            document.getElementById('active-session-dates').innerText = `${active.start} - ${active.end}`;
        } else {
            emptyDiv.style.display = 'block';
            activeDiv.style.display = 'none';
        }
        
        const histDiv = document.getElementById('wrapped-history');
        histDiv.innerHTML = '';
        history.forEach(s => {
            histDiv.innerHTML += `
                <div class="card" style="cursor:pointer;" onclick="SessionManager.showReport(${s.id})">
                    <div style="display:flex; justify-content:space-between; align-items:center;"><strong>${s.name}</strong><i class="fas fa-chevron-right text-muted"></i></div>
                    <p class="text-muted" style="font-size:12px;">${s.report ? s.report.totalHours + ' Ore' : 'Nessun dato'}</p>
                </div>`;
        });
    },
    showReport: (sessionId) => {
        const s = DB.data.uniSessions.find(x => x.id == sessionId);
        if(!s || !s.report) return;
        document.getElementById('report-title').innerText = s.name;
        document.getElementById('report-dates').innerText = `${s.start} - ${s.end}`;
        document.getElementById('rep-hours').innerText = s.report.totalHours;
        document.getElementById('rep-avg').innerText = s.report.dailyAvg + 'h';
        document.getElementById('rep-sessions').innerText = s.report.sessionsCount;
        
        const topDiv = document.getElementById('rep-top-topics');
        topDiv.innerHTML = '';
        s.report.topTopics.forEach((t, i) => topDiv.innerHTML += `<div style="padding:10px; border-bottom:1px solid rgba(0,0,0,0.05); display:flex; justify-content:space-between;"><span>${i+1}. ${t.name}</span> <span>${Math.round(t.mins)}m</span></div>`);
        
        const subDiv = document.getElementById('rep-subjects');
        subDiv.innerHTML = '';
        s.report.subjectsData.forEach(sub => subDiv.innerHTML += `<div style="margin-bottom:8px;"><div style="display:flex; justify-content:space-between; font-size:12px;"><span>${sub.name}</span><span>${Math.round(sub.mins/60)}h</span></div><div style="height:6px; background:#eee; border-radius:3px; overflow:hidden;"><div style="width:${Math.min(100, (sub.mins/(s.report.totalHours*60))*100)}%; background:${sub.color}; height:100%"></div></div></div>`);
        
        Router.go('wrapped-report');
    }
};

const Logic = {
    addSubject: () => {
        const name = document.getElementById('sub-name').value;
        const color = document.getElementById('sub-color').value;
        const exam = document.getElementById('sub-exam').value;
        if(!name || !exam) return alert("Compila tutto");
        DB.data.subjects.push({ id: Date.now(), name, color, examDate: exam });
        DB.save();
        Modal.close('modal-subject');
        document.getElementById('sub-name').value = '';
    },
    addTopic: () => {
        const subId = document.getElementById('topic-sub-id').value;
        const name = document.getElementById('topic-name').value;
        if(!name) return alert("Inserisci nome");
        DB.data.topics.push({ id: Date.now(), subId, name, isPlanned: false, difficulty: null });
        DB.save();
        Modal.close('modal-topic');
        document.getElementById('topic-name').value = '';
        alert("Creato! Vai al Timer.");
        Router.go('timer');
    },
    deleteSubject: (id) => {
        if(!confirm("Eliminare materia?")) return;
        DB.data.subjects = DB.data.subjects.filter(s => s.id != id);
        const tIds = DB.data.topics.filter(t => t.subId == id).map(t => t.id);
        DB.data.topics = DB.data.topics.filter(t => t.subId != id);
        DB.data.plan = DB.data.plan.filter(p => !tIds.includes(parseInt(p.topicId)));
        DB.data.sessions = DB.data.sessions.filter(s => !tIds.includes(parseInt(s.topicId)));
        DB.save();
    },
    deleteTopic: (id) => {
        if(!confirm("Eliminare argomento?")) return;
        DB.data.topics = DB.data.topics.filter(t => t.id != id);
        DB.data.plan = DB.data.plan.filter(p => p.topicId != id);
        DB.data.sessions = DB.data.sessions.filter(s => s.topicId != id);
        DB.save();
    }
};

const Timer = {
    int: null, sec: 0, activeTopicId: null,
    initDropdowns: () => {
        const sSel = document.getElementById('timer-subject');
        sSel.innerHTML = '<option value="">Scegli...</option>';
        DB.data.subjects.forEach(s => sSel.innerHTML += `<option value="${s.id}">${s.name}</option>`);
    },
    loadTopics: (subId) => {
        const tSel = document.getElementById('timer-topic');
        tSel.innerHTML = '<option value="">Scegli...</option>';
        if(!subId) return;
        const today = new Date().toISOString().split('T')[0];
        const available = DB.data.topics.filter(t => {
            if(t.subId != subId) return false;
            if(!t.isPlanned) return true;
            return DB.data.plan.some(p => p.topicId == t.id && p.date == today && !p.done);
        });
        if(available.length === 0) tSel.innerHTML = '<option value="">Nessun argomento</option>';
        else available.forEach(t => tSel.innerHTML += `<option value="${t.id}">${t.isPlanned ? "RIPASSO: " : "NUOVO: "}${t.name}</option>`);
    },
    start: () => {
        const id = document.getElementById('timer-topic').value;
        if(!id) return alert("Seleziona argomento");
        Timer.activeTopicId = id;
        Timer.sec = 0;
        document.getElementById('timer-select-ui').style.display = 'none';
        document.getElementById('btn-start').style.display = 'none';
        document.getElementById('btn-stop').style.display = 'inline-flex';
        Timer.int = setInterval(() => {
            Timer.sec++;
            const h = Math.floor(Timer.sec/3600).toString().padStart(2,'0');
            const m = Math.floor((Timer.sec%3600)/60).toString().padStart(2,'0');
            const s = (Timer.sec%60).toString().padStart(2,'0');
            document.getElementById('timer-display').innerText = `${h}:${m}:${s}`;
        }, 1000);
    },
    stop: () => {
        clearInterval(Timer.int);
        document.getElementById('rating-time').innerText = Math.ceil(Timer.sec / 60);
        Modal.open('modal-rating');
    },
    save: (rating) => {
        const mins = Math.ceil(Timer.sec / 60);
        const today = new Date().toISOString().split('T')[0];
        if(!DB.data.sessions) DB.data.sessions = [];
        DB.data.sessions.push({ id: Date.now(), topicId: Timer.activeTopicId, duration: mins, rating, date: new Date().toISOString() });
        const topic = DB.data.topics.find(t => t.id == Timer.activeTopicId);
        const subject = DB.data.subjects.find(s => s.id == topic.subId);
        if (!topic.isPlanned) {
            const dates = Scheduler.calculate(rating, today, subject.examDate);
            topic.isPlanned = true; topic.difficulty = rating;
            dates.forEach(d => DB.data.plan.push({ id: Date.now()+Math.random(), topicId: topic.id, date: d, done: false }));
            alert(`Piano: ${dates.length} ripassi.`);
        } else {
            const task = DB.data.plan.find(p => p.topicId == topic.id && p.date == today && !p.done);
            if(task) task.done = true;
            alert("Completato!");
        }
        DB.save();
        Modal.close('modal-rating');
        Timer.resetUI();
        Router.go('brief');
    },
    resetUI: () => {
        document.getElementById('timer-display').innerText = "00:00:00";
        document.getElementById('timer-select-ui').style.display = 'block';
        document.getElementById('btn-start').style.display = 'inline-flex';
        document.getElementById('btn-stop').style.display = 'none';
        document.getElementById('timer-subject').value = "";
    }
};

const Analytics = {
    render: () => {
        const sessions = DB.data.sessions || [];
        const todayStr = new Date().toISOString().split('T')[0];
        const todayMins = sessions.filter(s => s.date.startsWith(todayStr)).reduce((acc, s) => acc + s.duration, 0);
        const weekAgo = new Date(); weekAgo.setDate(weekAgo.getDate() - 7);
        const weekMins = sessions.filter(s => new Date(s.date) >= weekAgo).reduce((acc, s) => acc + s.duration, 0);
        document.getElementById('stat-today-hours').innerText = (todayMins/60).toFixed(1) + 'h';
        document.getElementById('stat-week-hours').innerText = (weekMins/60).toFixed(1) + 'h';
        document.getElementById('stat-sessions').innerText = sessions.length;
        const chartDiv = document.getElementById('analytics-chart');
        chartDiv.innerHTML = '';
        DB.data.subjects.forEach(sub => {
            const subTopics = DB.data.topics.filter(t => t.subId == sub.id).map(t => t.id);
            const subMins = sessions.filter(s => subTopics.includes(parseInt(s.topicId))).reduce((acc, s) => acc + s.duration, 0);
            if(subMins > 0) {
                chartDiv.innerHTML += `<div style="margin-bottom: 10px;"><div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:4px;"><span>${sub.name}</span><span>${(subMins/60).toFixed(1)}h</span></div><div style="height:8px; background:var(--bg-body); border-radius:4px;"><div style="width:100%; height:100%; background:${sub.color}; border-radius:4px;"></div></div></div>`;
            }
        });
    }
};

const Calendar = {
    view: 'month', ref: new Date(),
    nav: (d) => {
        const r = Calendar.ref;
        if(Calendar.view === 'month') r.setMonth(r.getMonth() + d);
        else if(Calendar.view === 'week') r.setDate(r.getDate() + (d*7));
        else if(Calendar.view === '3day') r.setDate(r.getDate() + (d*3));
        else r.setDate(r.getDate() + d);
        Calendar.render();
    },
    setView: (v, btn) => {
        Calendar.view = v;
        document.querySelectorAll('.cal-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        Calendar.render();
    },
    render: () => {
        const con = document.getElementById('cal-container');
        document.getElementById('cal-title').innerText = Calendar.ref.toLocaleDateString('it-IT', { month: 'long', year: 'numeric' });
        con.innerHTML = '';
        let days = []; const r = new Date(Calendar.ref);
        if (Calendar.view === 'month') {
            con.style.gridTemplateColumns = 'repeat(7, 1fr)';
            const start = new Date(r.getFullYear(), r.getMonth(), 1);
            const end = new Date(r.getFullYear(), r.getMonth() + 1, 0);
            const off = start.getDay() === 0 ? 6 : start.getDay() - 1;
            for(let i=0; i<off; i++) days.push(null);
            for(let i=1; i<=end.getDate(); i++) days.push(new Date(r.getFullYear(), r.getMonth(), i));
        } else if(Calendar.view === 'week') {
            con.style.gridTemplateColumns = 'repeat(7, 1fr)';
            const d = r.getDay(); const diff = r.getDate() - d + (d==0?-6:1);
            const mon = new Date(r.setDate(diff));
            for(let i=0; i<7; i++) { let x=new Date(mon); x.setDate(mon.getDate()+i); days.push(x); }
        } else if(Calendar.view === '3day') {
            con.style.gridTemplateColumns = 'repeat(3, 1fr)';
            for(let i=0; i<3; i++) { let x=new Date(r); x.setDate(r.getDate()+i); days.push(x); }
        } else {
            con.style.gridTemplateColumns = '1fr';
            days.push(new Date(r));
        }
        const grid = document.createElement('div');
        grid.className = 'cal-grid';
        grid.style.gridTemplateColumns = con.style.gridTemplateColumns;
        days.forEach(d => {
            const cell = document.createElement('div');
            cell.className = 'cal-cell';
            if(d) {
                const dateStr = d.toISOString().split('T')[0];
                cell.innerHTML = `<div style="text-align:right; font-weight:bold; margin-bottom:5px;">${d.getDate()}</div>`;
                DB.data.subjects.filter(s => s.examDate === dateStr).forEach(e => {
                    cell.innerHTML += `<div class="event-chip" style="background:#fee2e2; color:#ef4444; border-color:#ef4444;">ðŸŽ“ ${e.name}</div>`;
                });
                DB.data.plan.filter(p => p.date === dateStr).forEach(p => {
                    const top = DB.data.topics.find(t => t.id == p.topicId);
                    const sub = DB.data.subjects.find(s => s.id == top.subId);
                    if(top) cell.innerHTML += `<div class="event-chip" style="border-color:${sub.color}; text-decoration:${p.done?'line-through':'none'}; opacity:${p.done?0.6:1}">${top.name}</div>`;
                });
            } else { cell.style.background = 'transparent'; cell.style.border = 'none'; }
            grid.appendChild(cell);
        });
        con.appendChild(grid);
    }
};

const Router = {
    history: [], current: 'brief',
    go: (id) => {
        if(Router.current === id) return;
        Router.history.push(Router.current);
        Router.switch(id);
    },
    back: () => {
        if(Router.history.length === 0) return;
        const prev = Router.history.pop();
        Router.switch(prev);
    },
    switch: (id) => {
        Router.current = id;
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById(`view-${id}`).classList.add('active');
        document.getElementById('btn-back').style.display = Router.history.length > 0 ? 'block' : 'none';
        const map = {'brief':0, 'subjects':1, 'timer':2, 'calendar':3, 'wrapped':4, 'analytics':5, 'settings':6};
        if(map[id] !== undefined) document.querySelectorAll('.nav-item')[map[id]].classList.add('active');
        if(window.innerWidth <= 768) document.getElementById('sidebar').classList.remove('mobile-open');
        if(id === 'analytics') Analytics.render();
        if(id === 'brief') App.updateGreeting();
        if(id === 'timer') Timer.initDropdowns();
        if(id === 'wrapped') SessionManager.render();
    }
};

const Modal = {
    open: (id) => document.getElementById(id).classList.add('active'),
    close: (id) => document.getElementById(id).classList.remove('active')
};

const App = {
    init: () => {
        App.updateGreeting();
        const d = new Date();
        document.getElementById('current-date').innerText = d.toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'long' });
        if(localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');
        Timer.initDropdowns();
        App.render();
    },
    updateGreeting: () => {
        const h = new Date().getHours();
        let msg = "Buongiorno";
        if (h >= 13) msg = "Buon pomeriggio";
        if (h >= 18) msg = "Buonasera";
        document.getElementById('greeting-text').innerText = `${msg}, Studentessa`;
    },
    toggleSidebar: () => {
        const sb = document.getElementById('sidebar');
        if(window.innerWidth > 768) sb.classList.toggle('collapsed');
        else sb.classList.toggle('mobile-open');
    },
    toggleTheme: () => {
        document.body.classList.toggle('dark-mode');
        localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
    },
    reset: () => { if(confirm("Cancellare tutto?")) { localStorage.clear(); location.reload(); } },
    render: () => {
        const sGrid = document.getElementById('subjects-grid');
        sGrid.innerHTML = '';
        if(DB.data.subjects.length === 0) sGrid.innerHTML = `<p class="text-muted">Inizia creando una materia.</p>`;
        DB.data.subjects.forEach(s => {
            const planned = DB.data.topics.filter(t => t.subId == s.id && t.isPlanned).length;
            const unplanned = DB.data.topics.filter(t => t.subId == s.id && !t.isPlanned).length;
            sGrid.innerHTML += `
                <div class="card" style="border-top: 5px solid ${s.color}">
                    <div style="display:flex; justify-content:space-between; align-items:start;"><h3>${s.name}</h3><button class="btn-trash" onclick="Logic.deleteSubject(${s.id})"><i class="fas fa-trash"></i></button></div>
                    <p class="text-muted" style="font-size:13px;">Esame: ${s.examDate}</p>
                    <div style="font-size:12px; margin-top:5px;"><span>ðŸ“š ${planned} In corso</span> | <span style="color:var(--primary)">ðŸ†• ${unplanned} Nuovi</span></div>
                    <button class="btn btn-primary" style="margin-top:10px; font-size:12px; width:100%; justify-content:center;" onclick="document.getElementById('topic-sub-id').value='${s.id}'; Modal.open('modal-topic')">+ Argomento</button>
                </div>`;
        });
        const bList = document.getElementById('brief-list');
        const nList = document.getElementById('new-topics-list');
        bList.innerHTML = ''; nList.innerHTML = '';
        const today = new Date().toISOString().split('T')[0];
        DB.data.topics.filter(t => !t.isPlanned).forEach(t => {
            const sub = DB.data.subjects.find(s => s.id == t.subId);
            nList.innerHTML += `<div style="padding:10px; background:var(--bg-body); border-radius:8px; font-size:13px; margin-bottom:8px; border-left: 3px solid ${sub.color}; display:flex; justify-content:space-between;"><span>${t.name}</span><button class="btn-trash" onclick="Logic.deleteTopic(${t.id})"><i class="fas fa-trash" style="font-size:12px;"></i></button></div>`;
        });
        const tasks = DB.data.plan.filter(p => p.date <= today && !p.done);
        document.getElementById('brief-count').innerText = `${tasks.length} AttivitÃ `;
        if(tasks.length === 0) bList.innerHTML = '<p class="text-muted" style="padding:10px;">Tutto completato per oggi!</p>';
        tasks.forEach(p => {
            const topic = DB.data.topics.find(t => t.id == p.topicId);
            const sub = DB.data.subjects.find(s => s.id == topic.subId);
            bList.innerHTML += `<div style="padding:15px; background:var(--bg-body); border-radius:12px; margin-bottom:12px; border-left:4px solid ${sub.color}; display:flex; justify-content:space-between; align-items:center;"><div><strong style="display:block; margin-bottom:2px;">${topic.name}</strong><span style="font-size:11px; color:var(--text-muted)">${sub.name}</span></div><button class="btn btn-primary" style="padding:8px 16px; font-size:12px;" onclick="Router.go('timer')">Avvia</button></div>`;
        });
        Calendar.render();
        Analytics.render();
        SessionManager.render();
    }
};

App.init();
</script>
</body>
</html>